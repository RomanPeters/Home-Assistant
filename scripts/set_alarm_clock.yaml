set_alarm_clock:
  alias: Set Alarm Clock
  sequence:
    - alias: Set time
      service: input_datetime.set_datetime
      data_template:
        entity_id: input_datetime.alarm_clock
        time: >
          {% set cal = states('sensor.next_event') %}
          {% set alrm = as_timestamp(state_attr(cal, 'start_time')) - 3600 %}
          {% set now_ts = as_timestamp(now()) %}
          {% if  alrm - now_ts > 32400 and now().hour < 20 and now().hour > 9 %}
            {{ (now_ts + 1800) | timestamp_custom('%H:%M') }}
          {% elif  alrm - now_ts > 32400 %}
            {{ (now_ts + 32400) | timestamp_custom('%H:%M') }}
          {% elif alrm - now_ts < 3600 %}
            {{ (now_ts + 60) | timestamp_custom('%H:%M') }}
          {% else %}
            {{ alrm | timestamp_custom('%H:%M') }}
          {% endif %}


    - alias: Delay so state changes
      delay:
        seconds: 3
