set_alarm_clock:
  alias: Set Alarm Clock
  sequence:
    - alias: Set time
      service: input_datetime.set_datetime
      data_template:
        entity_id: input_datetime.alarm_clock
        time: >
          {% set low = as_timestamp(state_attr('calendar.rum_dmc', 'start_time')) %}
          {% set cal = 'calendar.rum_dmc' %}
          {% if  as_timestamp(state_attr('calendar.werk', 'start_time')) and as_timestamp(state_attr('calendar.werk', 'start_time')) < low %}
            {% set low = as_timestamp(state_attr('calendar.werk', 'start_time')) %}
            {% set cal = 'calendar.werk' %}
          {% endif %}
          {% if  as_timestamp(state_attr('calendar.studie', 'start_time')) and as_timestamp(state_attr('calendar.studie', 'start_time')) < low %}
            {% set low = as_timestamp(state_attr('calendar.studie', 'start_time')) %}
            {% set cal = 'calendar.studie' %}
          {% endif %}
          {% if  as_timestamp(state_attr('calendar.e_surveillant', 'start_time')) and as_timestamp(state_attr('calendar.e_surveillant', 'start_time')) < low %}
            {% set low = as_timestamp(state_attr('calendar.e_surveillant', 'start_time')) %}
            {% set cal = 'calendar.e_surveillant' %}
          {% endif %}
          {% if  as_timestamp(state_attr('calendar.cursusplanner', 'start_time')) and as_timestamp(state_attr('calendar.cursusplanner', 'start_time')) < low %}
            {% set low = as_timestamp(state_attr('calendar.cursusplanner', 'start_time')) %}
            {% set cal = 'calendar.cursusplanner' %}
          {% endif %}
          {% if  as_timestamp(state_attr('calendar.ws70', 'start_time')) and as_timestamp(state_attr('calendar.ws70', 'start_time')) < low %}
            {% set cal = 'calendar.ws70' %}
          {% endif %}
          {% set alrm = as_timestamp(state_attr(cal, 'start_time')) - 3600 %}
          {% set now_ts = as_timestamp(now()) %}
          {% if  alrm - now_ts > 32400 and now().hour < 20 and now().hour > 9 %}
            {{ (now_ts + 1800) | timestamp_custom('%H:%M') }}
          {% elif  alrm - now_ts > 32400 %}
            {{ (now_ts + 32400) | timestamp_custom('%H:%M') }}
          {% elif alrm - now_ts < 3600 %}
            {{ (now_ts + 60) | timestamp_custom('%H:%M') }}
          {% else %}
            {{ alrm | timestamp_custom('%H:%M') }}
          {% endif %}


    - alias: Delay so state changes
      delay:
        seconds: 3
