homekit:
  name: Hassio
  auto_start: false
  filter:
    exclude_entities:
      - script.start_homekit
      - automation.start_homekit
      - switch.television
      - binary_sensor.homekit_ready
      - script.television_on
      - script.television_off
      - switch.ikea_control_outlet_2
      - switch.xbox
      - person.roman_peters
      - light.ambilight
      - device_tracker.iphone_8
      - media_player.androidtv
  entity_config:
    switch.socket:
      type: outlet
    switch.ikea_control_outlet:
      type: outlet
    switch.ikea_control_outlet_2:
      type: outlet
    switch.entone:
      type: outlet
    switch.receiver:
      type: outlet
    media_player.television: 
      feature_list:
        - feature: on_off
        - feature: play_pause
        - feature: play_stop
        - feature: toggle_mute 
    media_player.androidtv:
      feature_list:
        - feature: on_off
        - feature: play_pause
        - feature: play_stop
        - feature: toggle_mute
    cover.fyrtur:
      linked_battery_sensor: sensor.battery_fyrtur
    cover.fyrtur_2:
      linked_battery_sensor: sensor.battery_fyrtur_2
    cover.fyrtur_3:
      linked_battery_sensor: sensor.battery_fyrtur_3


binary_sensor:
  - platform: template
    sensors:
      homekit_ready:
        friendly_name: HomeKit Ready
        value_template: >-
          {% if is_state("light.led_strip", "unavailable") or
                is_state("switch.entone", "unavailable") or
                not states("binary_sensor.xiaomi_contact_sensor") in ["on", "off"] or
                not states("binary_sensor.xiaomi_motion_sensor") in ["on", "off"] or
                not states("cover.ikea_fyrtur") in ["open", "closed"] or
                not states("light.ikea_rgbw_bulb") in ["on", "off"] or
                not states("light.xiaomi_ww_bulb") in ["on", "off"]
          %}
            False
          {% else %}
            True
          {% endif %}

script:
  start_homekit:
    sequence:
      - wait_template: "{{ is_state('binary_sensor.homekit_ready', 'on') }}"
      - service: homekit.start
      - service: persistent_notification.create
        data:
          title: "HomeKit"
          message: "HomeKit is online"


automation:
  - alias: Start HomeKit
    trigger:
      platform: homeassistant
      event: start
    action:
      service: script.start_homekit 
