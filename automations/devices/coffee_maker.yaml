# LED
- id: coffee_led_on
  alias: LED on if coffee maker on
  trigger:
    - platform: state
      entity_id: switch.coffee_maker
      from: 'off'
      to: 'on'
  action:
    - service: light.turn_on
      entity_id: light.coffee_led
    - service: timer.start
      entity_id: timer.make_coffee
    - service: notify.notify
      data_template:
        message: >
          {% set timestamp = as_timestamp(now()) %}
          {% set h, m, s = states.timer.make_coffee.attributes.duration.split(':') %}
          {% set duration_seconds = (h|float*3600) + (m|float*60) + s|float %}
          {% set custom_time = (timestamp + duration_seconds) | timestamp_custom('%H:%M') %}
            Your coffee will be ready at {{ custom_time }}.


- id: coffee_led_off
  alias: LED off if coffee maker off
  trigger:
    - platform: state
      entity_id: switch.coffee_maker    
      from: 'on'
      to: 'off'
  action:
    - service: light.turn_off
      entity_id: light.coffee_led
    - service: timer.cancel     
      entity_id: timer.make_coffee

# BUTTON
- id: coffee_button_on
  alias: Relay toggle on button
  trigger:
    - platform: state
      entity_id: binary_sensor.coffee_button
      from: 'off'
      to: 'on'
  action:
    - service: switch.toggle
      entity_id: switch.coffee_maker

# AUTO-OFF
- id: coffee_finished
  alias: Coffee finished
  trigger:      
    - platform: event
      event_type: timer.finished
      event_data: 
        entity_id: timer.make_coffee
  action:
    - service: switch.turn_off
      entity_id: switch.coffee_maker
    - service: timer.start
      entity_id: timer.cool_coffee
    - service: notify.notify
      data:
        message: "Your coffee is done \u2615"

- id: coffee_cooled
  alias: Coffee is at drinking temperature
  trigger: 
    - platform: event
      event_type: timer.finished
      event_data: 
        entity_id: timer.cool_coffee
  action:
    - service: notify.notify
      data:
        message: "Open to log caffe√Øne"
        data:
          url: "shortcuts://x-callback-url/run-shortcut?name=Coffee&x-success=launcher://crash"
