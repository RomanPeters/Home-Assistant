- id: alarm_clock_on
  alias: Set alarm clock
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_clock
      to: 'on'
    - platform: state
      entity_id: input_select.alarm_clock_time
    - platform: homeassistant
      event: start
  condition:
    - condition: state
      entity_id: input_boolean.alarm_clock
      state: 'on'
  action:
    - service: timer.start
      data_template:
        entity_id: timer.alarm_clock
        duration: >
          {% set year_day = now().strftime("%Y.%j.") %}
          {% set hour_minute = states("input_select.alarm_clock_time") %}
          {% set alarm =  strptime( year_day + hour_minute, "%Y.%j.%H:%M" ) %}

          {% if  as_timestamp(now()) > as_timestamp(alarm) %} 
              {% set day = now().strftime("%j") %}
              {% set day_plus = day | int + 1 %}
              {% set day_plus_str = day_plus | string %}   
              {% set year = now().strftime("%Y") %}
              {% set alarm =  strptime( year + '.' + day_plus_str + '.' + hour_minute, "%Y.%j.%H:%M" ) %}
          {% endif %}
 
          {% set duration = as_timestamp(alarm) - as_timestamp(now())  %}
          {% set duration_str = duration | string %}
          {{ duration_str.split('.')[0] }}
    - service: timer.start
      data_template:
        entity_id: timer.alarm_clock
        duration: >
          {% set year_day = now().strftime("%Y.%j.") %}
          {% set hour_minute = states("input_select.alarm_clock_time") %}
          {% set alarm =  strptime( year_day + hour_minute, "%Y.%j.%H:%M" ) %}

          {% if  as_timestamp(now()) > as_timestamp(alarm) %}
              {% set day = now().strftime("%j") %}
              {% set day_plus = day | int + 1 %}
              {% set day_plus_str = day_plus | string %}
              {% set year = now().strftime("%Y") %}
              {% set alarm =  strptime( year + '.' + day_plus_str + '.' + hour_minute, "%Y.%j.%H:%M" ) %}
          {% endif %}
 
          {% set duration = as_timestamp(alarm) - as_timestamp(now())  %}
          {% set duration_pre = duration - 1800 %}

          {% if  duration_pre < 0 %}
              {% set duration_pre = 0 %}
          {% endif %}

          {% set duration_str = duration_pre | string %}
          {{ duration_str.split('.')[0] }}
    - service: notify.notify
      data_template:
        message: "Your alarm has been set for {{ states('input_select.alarm_clock_time') }}"

- id: alarm_clock_off
  alias: Stop alarm clock
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_clock
      to: 'off'
  action:
    - service: timer.cancel
      entity_id: timer.alarm_clock

- id: trigger_pre_alarm_clock
  alias: Trigger pre-alarm clock
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.pre_alarm_clock
  action:
    - service: climate.set_operation_mode
      data:
        entity_id: climate.thermostat
        operation_mode: "Heat"
    
- id: trigger_alarm_clock_coffee
  alias: Trigger Alarm Clock Coffee
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.pre_alarm_clock
  condition:
    - condition: state
      entity_id: input_boolean.alarm_clock_coffee
      state: 'on'
  action:
    - service: script.turn_on
      entity_id: script.alarm_clock_coffee
    - service: input_boolean.turn_off
      entity_id: input_boolean.alarm_clock_coffee


- id: trigger_alarm_clock_light
  alias: Trigger Alarm Clock Coffee
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.pre_alarm_clock
  condition:
    - condition: template
      value_template: "{{ not is_state('input_select.alarm_clock_light', 'None') }}"
  action:
    - service: script.turn_on
      entity_id: script.alarm_clock_light

- id: trigger_alarm_clock_television
  alias: Trigger Alarm Clock Television
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.pre_alarm_clock
  condition:
    - condition: state
      entity_id: input_select.alarm_clock_sound
      state: 'Television'
  action:
    - service: script.turn_on
      entity_id: script.alarm_clock_television 

- id: trigger_alarm_clock_sound
  alias: Trigger Alarm Clock Sound
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.alarm_clock
  condition:
    - condition: template
      value_template: "{{ not is_state('input_select.alarm_clock_sound', 'None') and not is_state('input_select.alarm_clock_sound', 'Television') }}"
  action:
    - service: script.turn_on
      entity_id: script.alarm_clock_sound


# script.snooze_alarm_clock
# python_script.stop_alarm_clock     
